
name: Trivy CSPM Scan

on:
  pull_request:
    branches:
    - "*"

env:
  DOCKER_IMAGE: "accuknox/bootstrap:version-tag1"
  DOCKERFILE_CONTEXT: "Dockerfile"
  


  CSPM_URL: cspm.demo.accuknox.com
  CSPM_TOKEN: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ0b2tlbl90eXBlIjoic2xpZGluZyIsImV4cCI6MTY4NzU2NTkxMCwianRpIjoiOGRkZGQ5MDQyYWNmNDk4NWE0OWRhNGNmZWQ0YzhmMWIiLCJyZWZyZXNoX2V4cCI6MTY4NzU3OTQwNywidXNlcl9pZCI6MjY2LCJzdWIiOiIyNjYiLCJpYXQiOjE2ODc0OTMwMDcsInRlbmFudC1pZCI6MTY3LCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVsZXRlX2ZpbmRpbmdzX2NvbmZpZyIsImRlbGV0ZV9kYXRhbGlzdF9jb25maWciLCJkZWxldGVfY29tbWVudHNfYW5hbHlzaXMiLCJkZWxldGVfY29udHJvbHMiLCJkZWxldGVfdXNlcnMiLCJjd3BwX2RlbGV0ZV90YWdzIiwiYXBwcm92ZV9wb2xpY3kiLCJjd3BwX2dldF90YWdzIiwiY3JlYXRlX3RhcmdldHMiLCJkZWxldGVfZGF0YXBpcGVsaW5lX2ZpbHRlcnMiLCJkZWxldGVfZmluZGluZ19jb21tZW50cyIsImRlbGV0ZV9wb2xpY3kiLCJkZWxldGVfdGFyZ2V0cyIsImdldF90cmlnZ2Vyc19maWx0ZXJzIiwiZGVsZXRlX2NoYW5uZWxfaW50ZWdyYXRpb25zIiwiZGVsZXRlX3RhZ3MiLCJnZXRfZGF0YXBpcGVsaW5lX2ZpbHRlcnMiLCJjd3BwX2FkZF9yZWdpc3RyeSIsImV4cG9ydF9maW5kaW5ncyIsInZpZXdfZmluZGluZ3MiLCJkZWxldGVfZGF0YXBpcGVsaW5lX3RyaWdnZXJzIiwiYXNzZXRzX2FkZF90YWciLCJleHBvcnRfZGF0YWxpc3QiLCJkZWxldGVfYmFzZWxpbmVzIiwiZ2V0X2FsbF9jbHVzdGVycyIsImRhc2hib2FyZCIsInZpZXdfbm90aWZpY2F0aW9ucyIsImRlbGV0ZV9ncm91cHMiLCJkYXRhbGlzdF9hZGRfdG9fZ3JvdXAiLCJjd3BwX2RlbGV0ZV9sYWJlbF9lbnRpdGllcyIsInZpZXdfYXNzZXRzIiwiY3dwcF9nZXRfcmVnaXN0cnlfc2NhbnMiLCJ1cGRhdGVfZGF0YXBpcGVsaW5lX2ZpbHRlcnMiLCJjcmVhdGVfY29udHJvbHMiLCJjd3BwX2RlbGV0ZV9yZWdpc3RyeSIsImRlbGV0ZV90cmlnZ2Vyc19maWx0ZXJzIiwic2F2ZV90cmlnZ2Vyc19maWx0ZXJzIiwiY3dwcF9lZGl0X2xhYmVscyIsInZpZXdfY29udHJvbHMiLCJpZ25vcmVfcG9saWN5IiwiY3dwcF9kZWxldGVfbGFiZWxzIiwiZGVsZXRlX2Nsb3VkX2FjY291bnRzIiwiZGVsZXRlX21pbmlvbnMiLCJkZWxldGVfY29uZGl0aW9uIiwidmlld190YWdzIiwiY3JlYXRlX2NvbW1lbnRzX2FuYWx5c2lzIiwidmlld19jaGVja3MiLCJ2aWV3X2NvbW1lbnRzX2FuYWx5c2lzIiwiY3JlYXRlX3VzZXJzIiwiZGVsZXRlX3JlcG9ydHMiLCJkZWxldGVfcGxheWJvb2tzIiwiZGVsZXRlX21vbml0b3JzIiwiZGVsZXRlX3RpY2tldHMiLCJjd3BwX2dldF9sYWJlbF9lbnRpdGllcyIsInVwZGF0ZV9kYXRhcGlwZWxpbmVfdHJpZ2dlcnMiLCJkZWxldGVfc2V0dGluZ3MiLCJ0ZXN0X2NoYW5uZWxfaW50ZWdyYXRpb25zIiwiYWRkX3BvbGljeSIsImNyZWF0ZV9ub3RpZmljYXRpb25zIiwiY3JlYXRlX2RhdGFwaXBlbGluZV90cmlnZ2VycyIsImRlbGV0ZV9ub3RpZmljYXRpb25zIiwiZ2V0X3BvbGljeSIsImdldF9kYXRhcGlwZWxpbmVfdHJpZ2dlcnMiLCJjcmVhdGVfZmluZGluZ19jb21tZW50cyIsImVkaXRfcG9saWN5IiwiY3dwcF9lZGl0X3JlZ2lzdHJ5IiwiY3dwcF9hZGRfdGFncyIsImdldF9jaGFubmVsX2ludGVncmF0aW9ucyIsImdldF9hcHBfYmVoYXZpb3IiLCJzYXZlX2RhdGFwaXBlbGluZV9maWx0ZXJzIiwic2F2ZV9jaGFubmVsX2ludGVncmF0aW9ucyIsImZpbmRpbmdzX2FkZF90b19ncm91cCIsImNyZWF0ZV9maW5kaW5nc19jb25maWciLCJ2aWV3X3RhcmdldHMiLCJ2aWV3X3NjYW5zIiwidmlld190aWNrZXRzIiwiZGVsZXRlX2xhYmVscyIsInZpZXdfcmVwb3J0cyIsInZpZXdfY2xvdWRfYWNjb3VudHMiLCJjcmVhdGVfbW9uaXRvcnMiLCJjaGFuZ2VfcG9saWN5X3N0YXR1cyIsImNyZWF0ZV9taW5pb25zIiwiYXNzZXRzX3VwZGF0ZV9iYXNlbGluZXMiLCJpZ25vcmVfZmluZGluZ3MiLCJjcmVhdGVfYmFzZWxpbmVzIiwiZ2V0X2RhdGFwaXBlbGluZV90ZWxlbWV0cnkiLCJ2aWV3X2V4cGVjdGVkX3ZhcmlhYmxlIiwidmlld191c2VycyIsInZpZXdfZnVuY3Rpb25zIiwidGFnX3NjYW5zIiwidmlld19kYXRhbGlzdCIsInJ1bl9zY2FucyIsImRlbGV0ZV9zY2FucyIsImNyZWF0ZV90aWNrZXRzIiwiZmluZGluZ3NfYWRkX3RvX3RhcmdldCIsImNyZWF0ZV9jbG91ZF9hY2NvdW50cyIsImN3cHBfYWRkX2xhYmVscyIsImN3cHBfYWRkX2xhYmVsX2VudGl0aWVzIiwiY3JlYXRlX3RhZ3MiLCJjd3BwX2dldF9yZWdpc3RyeSIsInZpZXdfZmluZGluZ19jb21tZW50cyIsImN3cHBfZ2V0X2xhYmVscyIsInZpZXdfbW9kdWxlcyIsInZpZXdfZ3JvdXBzIiwidmlld19zZXR0aW5ncyIsImNyZWF0ZV9yZXBvcnRzIiwiY3JlYXRlX2xhYmVscyIsImNyZWF0ZV9jb25kaXRpb24iLCJ2aWV3X2xhYmVscyIsInVwZGF0ZV9maW5kaW5ncyIsInZpZXdfbWluaW9ucyIsImNyZWF0ZV9wbGF5Ym9va3MiLCJhZGRfdGFnX2ZpbmRpbmdzIiwiY3JlYXRlX3NldHRpbmdzIiwidmlld19jb25kaXRpb24iLCJzY3JlZW4iLCJkYXRhbGlzdF9hZGRfdG9fdGFyZ2V0Iiwidmlld19iYXNlbGluZXMiLCJ2aWV3X3BsYXlib29rcyIsInZpZXdfbW9uaXRvcnMiLCJjcmVhdGVfZ3JvdXBzIiwiY3JlYXRlX2RhdGFsaXN0X2NvbmZpZyJdfSwiaXNzIjoiY3NwbS5kZW1vLmFjY3Vrbm94LmNvbSJ9.c6ZpTnrLIu3pC4h_13vuUOtZtrBKiVwT5SeVQqRA6BalnHLv2zYA1NWfOXrTRVbHKSzpPrmagD6hFR1cNRK8nLoGj_TT_B_igLQeeQl9BHqGmRJGE7zOrf77whPQHi7BZJdgY2DKZbGSyITv8_ZycVGDGBRva1kRxZe3ZzwDkSRdc1R6AtfFoO3MViocIqT-4LP0ZryHzHgaacID9wb-xXxO0cKo1EaEbDsUwg7x8Vfi3LPR9IsPIV73nbBo0BAeeBMs2vrnu5lPzThQrpKLxmB66CsdlPOyaddeZNfrdSG_52xqsFAffidXcdmzRx7LtS_nS0-U2GcDYDaiRvzOfw"
  TENANT_ID: "167"

jobs:
  accuknox-cicd:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Docker Build
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }} -f ${{ env.DOCKERFILE_CONTEXT }} .

      - name: Download Trivy Vulnerability Scanner
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Run Trivy Vulnerability Scanner
        run: |
          trivy image -f json ${{ env.DOCKER_IMAGE }} -o results.json

      - name: Print Trivy Results
        run: cat results.json

      - name: Push report to CSPM panel
        run: |
          curl --location --request POST 'https://${{env.CSPM_URL}}/api/v1/artifact/?tenant_id=${{ env.TENANT_ID }}&data_type=TR&save_to_s3=false' --header 'Authorization: Bearer ${{ env.CSPM_TOKEN }}' --form 'file=@"./results.json"'
          
